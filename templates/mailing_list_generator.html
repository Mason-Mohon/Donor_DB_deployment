<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mailing List Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .header-actions {
            margin-bottom: 20px;
            text-align: right;
        }
        .action-button {
            background: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-left: 10px;
        }
        .action-button:hover {
            background: #0056b3;
        }
        .form-container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: inline-block;
            width: 150px;
            margin-right: 10px;
            font-weight: bold;
            color: #333;
        }
        input[type="text"],
        input[type="date"] {
            width: 300px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
        }
        .generate-button {
            background: #28a745;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .generate-button:hover {
            background: #218838;
        }
        .info-box {
            background: #d1ecf1;
            color: #0c5460;
            padding: 20px;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            margin: 20px 0;
        }
        .criteria-box {
            background: #fff3cd;
            color: #856404;
            padding: 20px;
            border: 1px solid #ffeeba;
            border-radius: 5px;
            margin: 20px 0;
        }
        .output-box {
            background: #d4edda;
            color: #155724;
            padding: 20px;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            margin: 20px 0;
        }
        .alert {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 3px;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .criteria-list {
            margin: 10px 0;
            padding-left: 20px;
        }
        .criteria-list li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .exclusion-note {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Find Mailing List Candidates</h1>

    <div class="header-actions">
        <a href="{{ url_for('home') }}" class="action-button">Back to Search</a>
        <a href="{{ url_for('generate_mailing_list') }}" class="action-button" style="background: #28a745;">Generate Mailing List</a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="info-box">
        <h3>About Mailing List Candidates</h3>
        <p>This tool finds potential donors who meet specific criteria but are not currently on the mailing list. Use this to discover new candidates, then add them to your active mailing list.</p>
    </div>

    <form method="POST" class="form-container">
        <h3>Find Candidates</h3>
        
        <div class="form-group">
            <label for="query_title">Mailing Title:</label>
            <input type="text" id="query_title" name="query_title" value="{{ request.form.get('query_title', '') }}" 
                   placeholder="e.g., Spring 2024 Campaign" required>
            <small style="color: #666; display: block; margin-top: 2px; margin-left: 160px;">
                This will be used in the CSV filename
            </small>
        </div>

        <div class="form-group">
            <label for="start_date">Start Date:</label>
            <input type="date" id="start_date" name="start_date" value="{{ request.form.get('start_date', '') }}" required>
            <small style="color: #666; display: block; margin-top: 2px; margin-left: 160px;">
                Reference date for transaction and donor criteria
            </small>
        </div>

        <div class="form-group">
            <label for="end_date">End Date:</label>
            <input type="date" id="end_date" name="end_date" value="{{ request.form.get('end_date', '') }}">
            <small style="color: #666; display: block; margin-top: 2px; margin-left: 160px;">
                If blank, defaults to today
            </small>
        </div>

        <div class="form-group">
            <label for="historical_start_date">Historical Start Date:</label>
            <input type="date" id="historical_start_date" name="historical_start_date" value="{{ request.form.get('historical_start_date', '') }}">
            <small style="color: #666; display: block; margin-top: 2px; margin-left: 160px;">
                If blank, defaults to 3 years before Start Date
            </small>
        </div>

        <div class="form-group">
            <label for="exclusion_start_date">Exclusion Start:</label>
            <input type="date" id="exclusion_start_date" name="exclusion_start_date" value="{{ request.form.get('exclusion_start_date', '') }}">
        </div>
        <div class="form-group">
            <label for="exclusion_end_date">Exclusion End:</label>
            <input type="date" id="exclusion_end_date" name="exclusion_end_date" value="{{ request.form.get('exclusion_end_date', '') }}">
            <small style="color: #666; display: block; margin-top: 2px; margin-left: 160px;">
                Optional: provide both dates to exclude donors with recent activity in the window
            </small>
        </div>

        <div style="display:flex; gap:10px; align-items:center;">
            <button type="submit" name="action" value="show" class="generate-button">
                Show Candidates
            </button>
            <button type="submit" name="action" value="download" class="generate-button" style="background:#0069d9;">
                Download CSV
            </button>
        </div>
    </form>

    <div class="criteria-box">
        <h3>ðŸ“‹ Candidate Selection Criteria</h3>
        <p><strong>This tool finds donors who meet the mailing list criteria but are NOT currently on the active mailing list.</strong></p>
        <p>Candidates are identified using the same proven criteria as the original mailing list generator, but filtered to show only those with <code>mailing_list_status = FALSE</code>.</p>
        
        <div class="exclusion-note">
            ðŸ’¡ <strong>Pro Tip:</strong> Use this tool regularly to discover donors who may have become eligible for mailing list inclusion due to recent activity or status changes.
        </div>
    </div>

    <div class="output-box">
        <h3>ðŸ“„ CSV Output Fields</h3>
        <p>The CSV contains: Full Name, Donor ID, Salutation, Company/Address Line 1, Address Line 2, Address Line 3, City, State, ZIP Code, Latest Transaction Date.</p>
        <p><strong>File naming:</strong> <code>[Your Title]_candidates_[timestamp].csv</code></p>
    </div>

    {% if candidates %}
    <div class="form-container" style="background:#fff;">
        <h3>Results ({{ total_results }} found)</h3>
        <table style="width:100%; border-collapse: collapse;">
            <thead>
                <tr style="background:#eee;">
                    <th style="text-align:left; padding:8px; border:1px solid #ddd;">Donor ID</th>
                    <th style="text-align:left; padding:8px; border:1px solid #ddd;">Full Name</th>
                    <th style="text-align:left; padding:8px; border:1px solid #ddd;">Donor Status</th>
                    <th style="text-align:left; padding:8px; border:1px solid #ddd;">Newsletter Status</th>
                    <th style="text-align:left; padding:8px; border:1px solid #ddd;">City</th>
                    <th style="text-align:left; padding:8px; border:1px solid #ddd;">State</th>
                    <th style="text-align:left; padding:8px; border:1px solid #ddd;">Latest Txn</th>
                    <th style="text-align:left; padding:8px; border:1px solid #ddd;">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for d in candidates %}
                {% set full_name = d.formatted_full_name or ((d.name_prefix ~ ' ' if d.name_prefix else '') ~ (d.first_name ~ ' ' if d.first_name else '') ~ (d.last_name if d.last_name else '') ~ (' ' ~ d.suffix if d.suffix else '')) %}
                <tr data-donor-id="{{ d.base_donor_id }}">
                    <td style="padding:8px; border:1px solid #ddd;">{{ d.base_donor_id }}</td>
                    <td style="padding:8px; border:1px solid #ddd;"><a href="{{ url_for('donor', donor_id=d.base_donor_id) }}" target="_blank" rel="noopener">{{ full_name|trim }}</a></td>
                    <td style="padding:8px; border:1px solid #ddd;">{{ d.donor_status or '' }}{% if d.donor_status_desc %} - {{ d.donor_status_desc }}{% endif %}</td>
                    <td style="padding:8px; border:1px solid #ddd;">{{ d.newsletter_status or '' }}{% if d.newsletter_status_desc %} - {{ d.newsletter_status_desc }}{% endif %}</td>
                    <td style="padding:8px; border:1px solid #ddd;">{{ d.city or '' }}</td>
                    <td style="padding:8px; border:1px solid #ddd;">{{ d.state or '' }}</td>
                    <td style="padding:8px; border:1px solid #ddd;">{{ d.latest_date or '' }}</td>
                    <td style="padding:8px; border:1px solid #ddd;">
                        <button class="action-button" style="background:#28a745;" onclick="toggleMailingList(event, '{{ d.base_donor_id }}', true)">Add</button>
                        <button class="action-button" style="background:#6c757d; display:none;" onclick="toggleMailingList(event, '{{ d.base_donor_id }}', false)">Undo</button>
                        <span class="row-status" style="margin-left:8px; color:#555;"></span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if total_pages and total_pages > 1 %}
        <div style="margin-top:15px; display:flex; gap:10px; align-items:center;">
            <form method="POST">
                <input type="hidden" name="action" value="show" />
                <input type="hidden" name="page" value="{{ current_page - 1 }}" />
                {% for key, val in submitted.items() %}
                <input type="hidden" name="{{ key }}" value="{{ val }}" />
                {% endfor %}
                <button class="action-button" {% if current_page <= 1 %}disabled{% endif %}>Prev</button>
            </form>
            <div>Page {{ current_page }} of {{ total_pages }}</div>
            <form method="POST">
                <input type="hidden" name="action" value="show" />
                <input type="hidden" name="page" value="{{ current_page + 1 }}" />
                {% for key, val in submitted.items() %}
                <input type="hidden" name="{{ key }}" value="{{ val }}" />
                {% endfor %}
                <button class="action-button" {% if current_page >= total_pages %}disabled{% endif %}>Next</button>
            </form>
        </div>
        {% endif %}
    </div>

    <script>
    async function toggleMailingList(event, donorId, enable) {
        event.preventDefault();
        const row = event.target.closest('tr');
        const buttons = row.querySelectorAll('button');
        const addBtn = buttons[0];
        const undoBtn = buttons[1];
        const statusEl = row.querySelector('.row-status');
        addBtn.disabled = true; undoBtn.disabled = true;
        statusEl.textContent = enable ? 'Addingâ€¦' : 'Undoingâ€¦';
        try {
            const resp = await fetch(`{{ url_for('quick_edit_mailing_list', donor_id=0) }}`.replace('0', donorId), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mailing_list_status: enable, mailing_until_date: '' })
            });
            const data = await resp.json();
            if (!data.success) throw new Error(data.error || 'Request failed');
            if (data.mailing_list_status === true) {
                addBtn.style.display = 'none';
                undoBtn.style.display = '';
                statusEl.textContent = 'On mailing list';
            } else {
                addBtn.style.display = '';
                undoBtn.style.display = 'none';
                statusEl.textContent = 'Removed';
            }
        } catch (e) {
            alert('Error: ' + e.message);
            statusEl.textContent = '';
        } finally {
            addBtn.disabled = false; undoBtn.disabled = false;
        }
    }
    </script>
    {% endif %}

    <div class="info-box">
        <h4>ðŸ’¡ Usage Tips</h4>
        <ul>
            <li><strong>Review candidates carefully:</strong> Check each candidate before adding them to your active mailing list</li>
            <li><strong>Choose your start date carefully:</strong> This date determines recent transaction criteria and lookback periods</li>
            <li><strong>Regular monitoring:</strong> Run this tool periodically to catch newly eligible donors</li>
            <li><strong>Next step:</strong> Use donor individual pages to update mailing list status for promising candidates</li>
        </ul>
    </div>
</body>
</html> 